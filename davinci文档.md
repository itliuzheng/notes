# davinci

这是一个前后端分离的项目

- 采用React的前端工程（antd、typescript echarts )
- 采用Spring Boot的后端工程
- 采用Jekyll + Minmal Mistakes的文档工程，用来介绍Davinci的用户操作方法

目录结构

![img](D:\zhidian_product\davinci\介绍\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L29yYWNsZTgwOTA=,size_16,color_FFFFFF,t_70)

davinci-ui存放的是前端编译好的静态资源

webapp  前端源码

├── app        # 主应用源码
 ├── assets      # 资源文件
 ├── components    # 通用组件
 ├── containers    # 路由容器组件
 ├── utils       # 通用实用方法
 └── app.tsx      # 主应用入口
├── internals     # 开发工程文件
├── libs       # 改动后的项目依赖
├── server      # 开发服务器
├── share       # 分享页源码
└── package.json



## 模块架构

![img](https://img-blog.csdnimg.cn/20200703125907172.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1pZQzg4ODg4,size_16,color_FFFFFF,t_70)



## 功能特点

- 数据源
  - 支持多种 JDBC 数据源
  - 支持 CSV 数据文件上传
  - ![img](https://img-blog.csdnimg.cn/20200703130028786.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1pZQzg4ODg4,size_16,color_FFFFFF,t_70)
- 数据模型
  - 支持友好 SQL 编辑器进行数据处理和转换
  - 支持自动和自定义数据模型设计和共享
- 可视化组件
  - 支持基于数据模型拖拽智能生成可视化组件
  - 支持各种可视化组件样式配置
  - 支持自由分析能力
- 数据门户
  - 支持基于可视化组件创建可视化仪表板
  - 支持可视化组件自动布局
  - 支持可视化组件全屏显示、本地控制器、高级过滤器、组件间联动、群控控制器可视组件
  - 支持可视化组件大数据量展示分页和滑块
  - 支持可视化组件 CSV 数据下载、公共分享授权分享以及可视化仪表板的公共分享和授权分享
  - 支持基于可视化仪表板创建数据门户
- 数据大屏
  - 支持可视化组件自由布局
  - 支持图层、透明度设置、边框、背景色、对齐、标签等更丰富大屏美化功能
  - 支持多种屏幕自适应方式
- 用户体系
  - 支持多租户用户体系
  - 支持每个用户自建一整套组织架构层级结构
  - 支持浅社交能力
- 安全权限
  - 支持 LDAP 登录认证（轻量级目录访问协议）
  - 支持动态 Token 鉴权
  - 支持细粒度操作权限矩阵配置
  - 支持数据列权限、行权限
- 集成能力
  - 支持安全 URL 嵌入式集成
  - 支持 JS 融入式集成
- 多屏适应
  - 支持大屏、PC、Pad、手机移动端等多屏自适应



## 实际使用介绍

### 数据源（Source）

用于管理用户数据源连接配置。Davinci 目前支持两种类型数据源：

1. 通过 JDBC 连接的数据源（配置详情参考 [安装 - 数据源配置](https://edp963.github.io/davinci/docs/zh/1.1-deployment#3-数据源配置)）；
2. 上传 CSV 文件到指定数据库中作为数据源（其文件以纯文本形式存储表格数据（数字和文本））

#### 新增数据源

在数据源列表页，点击右上角“+”按钮弹出新增数据源表单

![1.1](D:\zhidian_product\davinci\介绍\1.1.png)

![](https://edp963.github.io/davinci/assets/images/source/1.2.png)



目前支持 JDBC 和 CSV 两种数据源类型；**需要注意，CSV 类型数据源也需要指定一个数据库来存储上传的 CSV 文件内容，目前仅支持 mysql 数据库**

数据库为可选项，当所选的数据源在服务器配置了多个版本的情况下，必须选择数据库及其版本号。选择数据库之后连接 Url 会自动填充前缀

用户名和密码为数据源连接账户及密码，连接 URL 请填写完整 JDBC 连接地址，通常格式为

```sql
jdbc:<数据源名称>://<数据源域名或IP>:(<端口>)/<数据源实例>(?<连接参数>)
```

其中端口和连接参数为可选项。部分数据源在写法上有少许差异，比如名称和域名/IP之间不需要 `//`、参数连接符使用 `;` 等等

配置信息栏填写连接参数，以键值对的形式，可根据不同数据源情况自行填写

在输入完上述内容之后，可以点击“点击测试”按钮检查数据源是否可以正常连接；测试成功并填写完毕之后，点击下方的保存按钮保存数据源配置



#### 上传CSV文件数据

数据源添加完毕之后，如果是 CSV 类型数据源，下一步将准备上传 CSV 文件到数据库中

第一步，准备 CSV 文件，需要注意：

- 第一行为字段名称，建议使用英文

- 第二行为字段类型，使用大写字母

- 第三行之后为明细数据

- CSV 文件需要保存为 **UTF-8 格式**

  

![2.1](D:\zhidian_product\davinci\介绍\2.1.jpg)

第二步，点击“上传”按钮弹出配置表单

![CSV2](https://edp963.github.io/davinci/assets/images/source/2.2.png)

第三步，填写配置和上传 CSV 文件，其中表名为 CSV 文件内容在数据库中生成的表名称，主键和索引键为可选项，选择适当的导入方式

- 新增：在数据库中新建表并上传数据，当库中有相同名称表时会报错
- 替换：清空表原始数据并上传新数据
- 追加：在表原始数据基础上增量追加新数据
- 覆盖：重建表结构、清空表原始数据并上传新数据

其中“替换”和“覆盖”都会清空表原始数据，但区别在于，“替换”不改变表结构，“覆盖”会按照 CSV 文件中的字段信息重建表结构

最后，选择 CSV 文件，点击确定

![CSV3](https://edp963.github.io/davinci/assets/images/source/2.3.png)



#### 编辑和删除数据源

在数据源列表中可以对现有的数据源进行编辑和删除操作

#### 重置连接

Davinci 会在数据源连接断开之后自动尝试重连；当然，也可以在数据源列表页手动重新连接



### 数据视图(View)

数据视图（View）用于管理用户编写的 SQL 模板，和对执行 SQL 后获取到的数据模型以及行列权限进行配置

#### SQL编辑器

在数据视图列表页，点击右上角“+”按钮进入编辑器

![1.1 (1)](D:\zhidian_product\davinci\介绍\1.1 (1).png)



编辑器共分为4个区域：

![1.2](D:\zhidian_product\davinci\介绍\1.2.png)

- 左侧：数据源信息与数据视图表单

  数据视图表单包含名称、描述和关联数据源。当选择了关联数据源之后，下方的数据源信息会展示该数据源下的所有数据库；如果该数据源实例中只有一个数据库，会展示该数据库下的所有表。点击表名称前方的三角箭头会展示该表下的所有字段。通过上方的搜索框可以快速对数据库 / 表 / 字段信息做检索校对。目前数据源信息内容仅可以做预览校对作用

- 中上：SQL 编辑区

  编辑器会对以下内容自动提示：

  - 常用 SQL 关键字
  - 所选数据源的数据库 / 表 / 字段名称
  - 变量名称

- 中下：数据展示区

  展示 SQL 模板执行后获取的数据列表，默认展示 500 条预览数据，可配置

- 右侧：变量声明区

  管理 SQL 模板中使用的变量



##### **变量**

变量提供了将 SQL 动态化的能力；Davinci 支持两种变量类型：查询变量和权限变量

点击变量声明区右上角的“+“弹出新增变量表单

###### 查询变量

查询变量通过与 Widget 和 Dashboard 中的控制器关联，起到动态变化 SQL 模板的作用

![1.1.1](D:\zhidian_product\davinci\介绍\1.1.1.png)

查询变量有字符串、数字、布尔、日期、SQL表达式共 5 种值类型，值类型是为了对用户输入的变量值做正确的处理之后注入到 SQL 模板，Davinci 会自动给字符串、日期类型的变量值加上引号

查询变量通常需要添加默认值以避免 SQL 执行错误，用户可以选择手动添加或使用表达式（SQL函数）作为默认值

![查询变量](D:\zhidian_product\davinci\介绍\1.1.2.png)

如果没有给查询变量添加默认值，可以参考 [条件语句](https://edp963.github.io/davinci/docs/zh/2.2-view#12-条件语句) 章节的写法避免 SQL 执行错误

填写完表单保存之后，就可以在 SQL 模板中使用 `$变量名称$` 语法引入查询变量

![查询变量](D:\zhidian_product\davinci\介绍\1.1.3.png)

另外值得一说的是，Davinci 不会对 SQL 表达式类型的查询变量值做任何处理，所以理论上 SQL 表达式类型的查询变量值可以是任意 SQL 片段，用户可以通过与控制器搭配使用以达到非常灵活的效果

![查询变量](D:\zhidian_product\davinci\介绍\1.1.4.png)

![查询变量](D:\zhidian_product\davinci\介绍\1.1.5.png)

###### 权限变量

权限变量可以通过与角色关联，起到控制数据行权限的作用

![权限变量](D:\zhidian_product\davinci\介绍\1.2.1.png)

权限变量同样有字符串、数字、布尔、日期、SQL表达式共 5 种值类型。填写完表单保存之后，在 SQL 模板中使用 `(<字段> <运算符> $变量名称$)` 语法引入权限变量，**注意：权限变量所在的条件判断片段一定要使用小括号包裹**

![权限变量](D:\zhidian_product\davinci\介绍\1.2.2.png)

点击下一步，在 Auth 页签里管理项目所关联角色与权限变量的对应关系。当复选框未被勾选时，意味着该权限变量对该角色不生效，那么对该角色来说 `(<字段> <运算符> $变量名称$)` 小括号内的条件判断片段会被替换为 `(1 = 1)`；当复选框被勾选后，权限变量对该角色将会应用用户添加的值。单个权限变量可以添加多个值。

![权限变量](D:\zhidian_product\davinci\介绍\1.2.3.png)

###### 系统变量

系统变量用于做用户粒度权限控制，Davinci 内置了以下5个系统变量

- $DAVINCI.USER.ID$：登录用户ID
- $DAVINCI.USER.NAME$：登录用户姓名
- $DAVINCI.USER.USERNAME$：登录用户用户名
- $DAVINCI.USER.EMAIL$：登录用户邮箱
- $DAVINCI.USER.DEPARTMENT$：登录用户部门

在 dashboard 和 display 中获取数据时，系统变量会替换为登录用户的相关信息。系统变量对组织拥有者和项目管理员不生效。



##### 条件语句

SQL 模板支持简单的条件语句结合变量一起使用。Davinci 服务端使用 [StringTemplate](https://www.stringtemplate.org/) 对 SQL 模板进行解析，因此在条件语法上支持 `if...else...` 以及 `&& || !` 判断（不支持算数运算符，点击此处 [查看详情](https://github.com/antlr/stringtemplate4/blob/master/doc/templates.md#conditionals)）。如果对查询变量进行了条件判断，那么不设置默认值也不会报错。

![条件语句1](D:\zhidian_product\davinci\介绍\1.2.4.png)

如果期望多个变量同时作用于过滤条件且互不影响，可以考虑如下写法

![条件语句2](D:\zhidian_product\davinci\介绍\1.2.5.png)

##### 快捷操作

在 SQL 编辑区中，可以使用 

`Command` + `Enter`（MacOS）

`Ctrl` + `Enter`（Windows）

组合键来快捷执行/中止 SQL。



同时，也可以使用光标选择部分 SQL 语句执行。但仅执行部分 SQL 语句是无法点击下一步按钮的，必须执行完整 SQL 语句

![快捷操作2](D:\zhidian_product\davinci\介绍\1.3.2.png)



#### 数据模型

数据模型是对数据视图中的数据进行提前归类，以便更好地进行可视化开发。在编写完 SQL 模板并成功执行之后，点击下一步，在 Model 页签中编辑数据模型

![数据模型](D:\zhidian_product\davinci\介绍\2.1.png)

数据类型有维度和指标 2 种，用于可视化组件生成基本的可视化编码逻辑；可视化类型有字符、数字、日期、地理国家、地理省份、地理城市 6 种，用于字段格式设置、提示和地图显示。**如果准备在可视化组件中使用地图显示数据的话，请提前将对应的省份、城市字段标记可视化类型（目前仅支持中国地图），否则将无法正常显示**



Davinci 前端在拿到数据视图执行结果的 meta 信息之后会对字段的数据类型和可视化类型做预匹配，无法正确匹配的字段将会默认数据类型为维度、可视化类型为字符。



#### 行列权限

在 Auth 页签里可以配置项目所关联角色的数据行权限与列权限

##### 行权限

在 [权限变量](https://edp963.github.io/davinci/docs/zh/2.2-view#112-权限变量) 章节中介绍了如何设置角色的数据行权限

##### 列权限

通过点击“可见字段”列的标签会弹出字段列表，通过勾选来控制角色的数据列权限，默认全部可见。

![行列权限](D:\zhidian_product\davinci\介绍\3.1.png)



### 可视化组件(Widget)

可视化组件（Widget）是 Davinci 打造可视化应用的最小单元。依据数据视图（View）提供的数据模型对SQL结果进行二次聚合分组，然后将二次加工的数据进行可视化编码。

#### 设计原理

可视化组件编辑器通过将数据视图中的原始 SQL 语句与数据模型进行组合，生成新的 SQL 语句到数据库中执行，拿到图表展示所需要的数据

![设计原理](D:\zhidian_product\davinci\介绍\1.11.png)

#### 组件配置

在数据视图列表页，点击右上角“+”按钮进入编辑器

![图表配置2](D:\zhidian_product\davinci\介绍\2.2.png)

编辑器共分为3个区域：

- 左侧：数据模型展示区

  在左上角选择了对应的数据视图（View）之后，会将所选视图的模型分类展示在下方，维度字段展示在“分类型”列表中，指标字段展示在“数值型”列表中。用户可拖拽字段到图表配置区“数据”页签对应的区域中

- 中部：图表配置区

  顶部用于选择驱动模式与图表类型，将鼠标移动到图表类型图标上会提示使用该图表需要的维度和指标数量

  下方有3个页签：

  数据：用于添加图表所需的模型字段，用户通过拖拽数据模型展示区的字段来满足可视化展示需求

  样式：图表样式配置

  配置：功能性配置，如控制器、缓存

- 右侧：图表展示区

##### 驱动模式

Davinci 支持两种可视化展示逻辑：透视驱动和图表驱动，用于支持不同的使用场景

1. 透视驱动

   透视驱动是以[透视表](https://en.wikipedia.org/wiki/Pivot_table)为基础的可视化展示逻辑。图表可视为对透视表进行可视化编码，通过将透视表中的维度和指标转换为轴来做图形化展示。在透视驱动逻辑下，每个指标可以做不同的图形编码，在维度栏中最下层级的维度可以视为公用的维度轴

   透视驱动适用于少量数据在客户端的自由分析场景

   *目前透视驱动的配置项完善度不如图表驱动，我们会在未来逐步完善透视驱动的功能*

2. 图表驱动

   图表驱动即为常规的、基于图表分类的可视化展示逻辑。图表驱动下的图表种类要丰富很多，维度和指标可视为固定配置项，与其他的样式配置一同服务于图表。

   图表驱动适用于大多数可视化展示场景

##### 数据配置

用户需要拖拽数据模型展示区的字段到“数据”页签对应的区域中来完成图表展示所需的数据配置，字段可放置区域会高亮提示

![数据配置](D:\zhidian_product\davinci\介绍\2.2.1.gif)

1. 维度

   维度区域只能放置分类型字段，会对拖入的字段在 SQL 中进行分组

2. 指标

   指标区域只能放置数值型字段，会对拖入的字段在 SQL 中进行聚合，目前支持以下6种聚合函数：

   1. 总计（sum）
   2. 平均数（avg）
   3. 计数（count）
   4. 去重计数（count_distinct）
   5. 最大值（max）
   6. 最小值（min）

   点击字段名称进行聚合函数选择

   ![指标1](D:\zhidian_product\davinci\介绍\2.2.2.1.png)

   指标区域内的字段可以进行数值格式设置，目前支持以下格式：

   1. 默认格式

   2. 数值：可以设置小数位数、单位和启用千分位分隔符

   3. 货币：可以设置小数位数、单位、启用千分位分隔符和前/后缀文本

   4. 百分比：可以设置小数位数

   5. 科学型：可以设置小数位数

      ![指标2](D:\zhidian_product\davinci\介绍\2.2.2.2.png)

3. 筛选

   筛选区域支持任意类型字段，会对拖入的字段在 SQL 中进行条件过滤，支持固定值、条件和日期三种筛选方式

   - 固定值筛选：界面左侧会陈列出所选字段的值列表（distinct），用户通过选择左侧的内容到右侧进行固定值筛选

   ![筛选1](D:\zhidian_product\davinci\介绍\2.2.3.1.png)

   - 条件筛选：用户可以在界面中自由配置所选字段的过滤条件，同时可以配置各个条件之间的“与”（and）“或”（or）关系，是最灵活的筛选方式

   ![筛选2](D:\zhidian_product\davinci\介绍\2.2.3.2.png)

   - 日期筛选：支持所选字段的动态和固定时间范围筛选

   ![筛选3](D:\zhidian_product\davinci\介绍\2.2.3.3.png)

   筛选区域中的字段会根据用户在数据视图中设置的可视化类型来选择性地展示对应的筛选方式

   - 字符和地理位置：固定值筛选和条件筛选
   - 数值：条件筛选
   - 日期：日期筛选

4. 颜色

   颜色区域目前只能放置一个分类型字段，会对拖入的字段在 SQL 中进行分组。在图表展示上会根据所选字段值进行系列分组，可以通过图例来查看各个系列

   ![颜色1](D:\zhidian_product\davinci\介绍\2.2.4.1.png)

   需要注意，诸如展示饼图时需要通过某个维度来进行分组，那么只需将这个字段拖拽到颜色区域即可

   ![颜色2](D:\zhidian_product\davinci\介绍\2.2.4.2.png)

5. 其他

   
   尺寸：用于散点图做节点大小编码，只能放置数值型字段，会对拖入的字段在 SQL 中进行聚合

   提示信息：仅部分直角坐标系图表支持，只能放置数值型字段，会对拖入的字段在 SQL 中进行聚合

   透视驱动下的图表标签需要拖拽字段指定，支持任意类型字段，会对拖入的分类型字段在 SQL 中进行分组、数值型字段在 SQL 中进行聚合

   透视驱动下的散点图需要额外指定x轴指标，只能放置数值型字段，会对拖入的字段在 SQL 中进行聚合

   图表驱动下的双Y轴图可以分别指定左右Y轴指标

6. 通用设置

   · 别名

   点击字段名称，选“字段设置”项，可进行字段别名设置。支持固定别名和动态别名设置

   动态别名通过编写 JavaScript 代码来生成，可以和变量一起使用，目前仅支持表格组件

   ![别名1](https://edp963.github.io/davinci/assets/images/widget/2.2.6.1.1.png)

   内置了 JavaScript Moment 类库，可以结合变量动态生成日期别名

   ![别名2](https://edp963.github.io/davinci/assets/images/widget/2.2.6.1.2.png)

   · 描述

   点击字段名称，选“字段设置”项，可进行字段描述设置，目前仅在图表驱动的表格里作用

   ![描述1](https://edp963.github.io/davinci/assets/images/widget/2.2.6.2.1.png)

   · 排序

   点击字段名称，在“排序”项进行字段排序设置，目前支持：

   1. 默认，即不排序
   2. 升序，在 SQL 中以此字段升序
   3. 降序，在 SQL 中以此字段降序
   4. 自定义，仅分类型字段支持，用户可拖拽字段值决定展示顺序，**在浏览器端以用户自定义顺序排序**

##### 图标配置

在选择完字段之后，可以点击图表配置区顶部的小图标来选择进行可视化编码的图表。鼠标移动到小图标上可以查看该图表展示的先决条件，当先决条件不满足时图标呈置灰状态且不可点击，满足后图标呈高亮状态，点击后右侧会展示图表

![图表配置1](D:\zhidian_product\davinci\介绍\2.3.1.png)

图表配置区下方“样式”页签中，用户可以对图表进行表单化配置，详情可以查看[图表配置](https://edp963.github.io/davinci/docs/zh/5.1-chart_config)附录

Davinci 中使用的图表主要来自[echarts](https://www.echartsjs.com/)

##### 功能配置

图表配置区下方“配置”页签中，用户可以配置控制器、参考线、展示数据量、缓存以及是否自动加载数据

![功能配置1](D:\zhidian_product\davinci\介绍\2.4.1.png)

##### 控制器

组件控制器的配置过程和仪表板[全局控制器](https://edp963.github.io/davinci/docs/zh/2.4-dashboard#26-全局控制器)基本类似，除了不用关联图表；功能上也基本一致

![控制器1](D:\zhidian_product\davinci\介绍\2.4.1.1.png)

在仪表板中添加带有控制器的组件之后，可以点击组件左上角按钮打开控制器面板，选择内容之后，点击面板右下角查询按钮进行查询。组件控制器与全局控制的过滤条件对组件叠加生效

![控制器2](D:\zhidian_product\davinci\介绍\2.4.1.2.png)

##### 参考线

可以给部分直角坐标系图表设置参考线和参考区间，目前仅支持折线图、柱状图、散点图和双Y轴图

1. 参考线

参考线需要关联到1个指标，数值可以选择关联指标的最大值、最小值、平均值，也可以选择手动设置常量值

![参考线1](D:\zhidian_product\davinci\介绍\2.4.2.1.1.png)

![参考线2](D:\zhidian_product\davinci\介绍\2.4.2.1.2.png)

2. 参考区间

参考区间需要设置起始值和结束值，每个值分别需要关联1个指标，数值可以选择关联指标的最大值、最小值、平均值，也可以选择手动设置常量值

![参考区间1](D:\zhidian_product\davinci\介绍\2.4.2.2.1.png)

![参考区间2](D:\zhidian_product\davinci\介绍\2.4.2.2.2.png)

##### 展示数据量

用于限制图表展示数据量

![展示数据量](D:\zhidian_product\davinci\介绍\2.4.3.1.png)

##### 缓存

用户可以配置缓存的开启/关闭和有效期。开启缓存后，在可视化应用（Viz）中该组件首次查询会将结果存储到 redis 中，使用 SQL 语句作为 key。之后在缓存有效期内的、SQL 语句相同的查询将直接返回缓存结果，不再访问数据源

缓存功能需要[配置redis](https://edp963.github.io/davinci/docs/zh/1.1-deployment#245-cache-配置可选)之后才可以正常使用

##### 初始化加载

在有些查询压力较大的场景下，用户不希望在打开仪表板时组件立即加载数据，可以设置“自动加载数据”项为否，默认情况为是。

#### 编辑器设置

点击编辑器右上角的设置按钮可以设置查询触发模式和多选拖拽

![编辑器设置](D:\zhidian_product\davinci\介绍\31.1.png)

1. 查询触发模式

默认为立即触发，即拖拽字段到数据页签后立即查询并刷新右侧图表。如果数据视图的查询时间较长，可以尝试设置查询触发模式为手动来缓解数据库压力；设置为手动之后，图表配置区中间会显示一个查询按钮，拖拽字段不再触发查询，需要点击按钮触发

![查询触发模式](D:\zhidian_product\davinci\介绍\3.1.1.png)

2. 多选拖拽

有些场景下表格需要展示10个以上字段，在这种情况下多选拖拽可以很好地辅助编辑者工作

![多选拖拽](D:\zhidian_product\davinci\介绍\3.2.1.gif)



### 仪表板（Dashboard）

Davinci 提供了两个可视化应用（Viz），仪表板（Dashboard）是其中之一；仪表板提供自动布局和可交互能力，帮助用户快速打造可视化报表	

#### 功能

##### 添加组件

点击仪表板右上角的“+”按钮，弹出可视化组件列表，选择需要添加到该仪表板上的组件

下一步中指定组件数据更新模式，支持以下两种模式：

1. 手动更新：通过点击组件右上角“同步数据”按钮更新数据
2. 定时更新：根据所设置的更新时长定时自动轮询更新数据，时长单位为秒

##### 自动布局

用户可以拽住组件右下角调整尺寸

##### 分享
 1. 普通分享

    输入有效期后，点击生成分享链接，在任意浏览器打开链接即可查看分享页，分享页的数据权限与分享者一致

2. 口令分享

   输入有效期后，点击生成分享链接和口令，在任意浏览器打开链接，需要输入正确口令才能查看分享页，分享页的数据权限与分享者一致

3. 授权分享

   授权分享可以将仪表板分享给所属组织里的角色和成员，仅有授权的角色及成员登录后才能查看分享页

   在配置界面，可以选择想要授权的角色和成员，同样需要输入有效期；授权分享页的数据权限有2种，在配置界面可以选择

   1. 与分享者一致：分享页的数据权限与分享者一致
   2. 使用被分享者自身权限：授权用户登录进入分享页之后，看到的数据与他自身在组织、项目内的权限保持一致

##### 下载

用户可以下载仪表板和可视化组件的明细数据 Excel 文件；仪表板下载按钮在仪表板右上角左数第三个，组件下载按钮在组件右上角左数第五个。

##### 联动

仪表板中的组件之间可以配置联动关系，点击仪表板右上角左数第四个按钮打开配置面板

一个仪表板中可以配置多条联动关系，每条关系中包含一个触发器和一个联动图表，用户需要指定触发器与联动图表之间的字段对应关系

触发器只能选择图表所用到的字段，联动图表可以选择数据视图模型中的任意字段和变量；触发器与联动图表所选的字段类型必须一致

以下图为例，当添加了“学历年龄分布”组件作为触发器、其“education”字段作为输出条件，“城市薪水排名”作为联动图表、其“education”字段作为输入条件这样一条联动关系之后，点击“学历年龄分布”组件中的图表元素会根据输入的“education”内容对“城市薪水排名”中的数据做条件过滤




![联动3](D:\zhidian_product\davinci\介绍\2.5.3.png)

![联动4](D:\zhidian_product\davinci\介绍\2.5.4.gif)

通过配置多条联动关系，可以支持一个触发器联动多个图表，也支持多个触发器联动一张图表、过滤条件叠加生效；在配置界面右侧的关系图中可以一览联动关系

![联动5](D:\zhidian_product\davinci\介绍\2.5.5.png)

作为联动触发器的组件左上角有操作提示

![联动6](D:\zhidian_product\davinci\介绍\2.5.6.png)

##### 全局控制器

全局控制器能够支持用户对仪表板中的一个或多个组件做条件过滤或是变量输入；点击仪表板右上角最右侧按钮打开配置面板，面板左侧为控制器列表，右侧为配置表单

###### 1.查询模式

###### 2.控制器配置

​		1. 通用配置

​		2. 下拉菜单

​		3. 单选按钮

​		4. 日期选择

​		5. 日期范围

​		6. 文本输入框

​		7. 数字范围输入框

​		8. 数字滑块

​		9. 下拉树

######  3.级联

控制器之间可以通过拖拽的方式配置级联关系，当控制器之间为级联关系时，上级控制器的输入内容将作为下级控制器（下拉菜单）选项取值的过滤条件

![级联1](D:\zhidian_product\davinci\介绍\2.6.3.1.gif)

![级联2](D:\zhidian_product\davinci\介绍\2.6.3.2.gif)

###### 4.分享页参数传递

######  5.自定义选项关联变量

##### 同步数据（更新缓存）

##### 全屏展示
##### 自由钻取

仪表板中部分图表类型支持自由[钻取](https://en.wikipedia.org/wiki/Data_drilling)；Davinci 中自由钻取的基本逻辑是：先点击图表元素进行条件过滤，然后点击鼠标右键选择维度进行钻取

以下图为例，用户选择“上海”、“深圳”、“广州”三项图表元素，钻取到“education”字段，此时图表的展示逻辑是：上海、深圳、广州三个城市的教育程度与薪水分布图

![自由钻取1](D:\zhidian_product\davinci\介绍\2.9.1.gif)

可视化组件左下角会展示图表的钻取路径，用户可以选择之前任意一级路径返回

![自由钻取2](D:\zhidian_product\davinci\介绍\2.9.2.gif)

支持自由钻取的组件在左上角有操作提示

![自由钻取3](D:\zhidian_product\davinci\介绍\2.9.3.png)

需要注意，作为[联动](https://edp963.github.io/davinci/docs/zh/2.4-dashboard#25-联动)触发器的图表将无法进行自由钻取操作

自由钻取在透视驱动与图表驱动模式下有一定的区别

1. 透视驱动

   透视驱动下的自由钻取，是在条件过滤的基础上，在透视表中增加/减少维度来观察数据变化

   在透视表中，可以选择钻取方式为上卷或下钻，上卷即为去掉该维度，下钻即为增加该维度；同时透视表中可以选择钻取到行或列

   ![透视驱动1](D:\zhidian_product\davinci\介绍\2.9.1.1.gif)

2. 图表驱动

   在图表驱动下，表格的自由钻取逻辑与透视表类似；其他图表是在条件过滤的基础上，将钻取的维度对图表中现有维度进行替换，以另一个维度观察数据变化

   目前图表驱动中支持自由钻取的图表类型有

   - 表格
   - 柱状图
   - 折线图
   - 散点图
   - 饼图
   - 漏斗图
   - 双Y轴图

##### 组件设置
1. 编辑组件

2. 设置组件别名

3. 组件基本信息

4. 删除组件



### 大屏(Display)

大屏（Display）是 Davinci 提供的第二个可视化应用，提供自由布局和自定义样式能力，通过可视化组件和一系列内置辅助图形来打造视觉呈现丰富的可视化大屏

大屏的定位与仪表板不一样，仪表板倾向于快速打造可视化报表，而大屏通常被广泛用于静置或滚动观看和演示的场景，因此大屏的制作过程通常需要比仪表板花更多的时间，需要用户准备素材（如背景图）来丰富大屏的样式



### 定时任务

定时任务（Schedule）功能支持用户对已制作完成的可视化应用配置定时事件，目前支持邮件和企业微信



## 使用统计

使用统计会记录用户在可视化应用中的使用数据以及登录终端信息，在使用之前请确保在服务器配置中[开启使用统计](https://edp963.github.io/davinci/docs/zh/1.1-deployment#246-使用统计配置)



默认配置下，统计数据会记录到 

`davinci_statistic_visitor_operation`
`davinci_statistic_duration`
`davinci_statistic_terminal`
三张表中，以下是这三张表的字段详情

## 1 可视化应用操作记录表

davinci_statistic_visitor_operation

| 字段         | 描述                          |
| :----------- | :---------------------------- |
| id           | ID                            |
| user_id      | 用户ID                        |
| email        | 用户邮箱                      |
| action       | 用户操作（见附录）            |
| org_id       | 组织ID                        |
| project_id   | 项目ID                        |
| project_name | 项目名称                      |
| viz_type     | 应用类型：dashboard / display |
| viz_id       | 应用ID                        |
| viz_name     | 应用名称                      |
| sub_viz_id   | 子应用ID                      |
| sub_viz_name | 子应用名称                    |
| widget_id    | 组件ID                        |
| widget_name  | 组件名称                      |
| filters      | 过滤参数                      |
| variables    | 变量参数                      |
| groups       | 分组参数                      |
| create_time  | 创建时间                      |

### 1.1 附录

| 用户操作 | 描述       |
| :------- | :--------- |
| login    | 登录       |
| visit    | 访问应用   |
| initial  | 初始化查询 |
| sync     | 同步数据   |
| search   | 控制器查询 |
| linkage  | 联动查询   |
| drill    | 钻取查询   |
| download | 下载       |
| print    | 打印       |

## 2 用户使用时长记录表

davinci_statistic_duration

| 字段       | 描述     |
| :--------- | :------- |
| id         | ID       |
| user_id    | 用户ID   |
| email      | 用户邮箱 |
| start_time | 开始时间 |
| end_time   | 结束时间 |

## 3 登录终端信息记录表

davinci_statistic_terminal

| 字段             | 描述         |
| :--------------- | :----------- |
| id               | ID           |
| user_id          | 用户ID       |
| email            | 用户邮箱     |
| browser_name     | 浏览器名称   |
| browser_version  | 浏览器版本   |
| engine_name      | 内核名称     |
| engine_version   | 内核版本     |
| os_name          | 操作系统名称 |
| os_version       | 操作系统版本 |
| device_model     | 设备型号     |
| device_type      | 设备类型     |
| device_vendor    | 设备供应商   |
| cpu_architecture | CPU架构      |
| create_time      | 创建时间     |